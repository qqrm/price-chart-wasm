name: deploy-monitor
# docs/version contains the SHA of the last commit
on:
  workflow_run:
    workflows: ["build"]
    types:
      - completed
concurrency:
  group: deploy-monitor-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

jobs:
  monitor:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Check version
        id: check_version
        run: |
          for i in {1..6}; do
            version=$(curl -fsSL https://qqrm.github.io/webgpu-candles/version)
            if [ "$version" = "${{ github.event.workflow_run.head_sha }}" ]; then
              echo "version=$version" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            sleep 300
          done
          echo "Version not updated"
          exit 1

      - name: Notify
        if: success()
        env:
          NOTIFY_MESSAGE: "Deployment succeeded: ${{ steps.check_version.outputs.version }}"
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: python scripts/notify_bot.py

